<!DOCTYPE html>
<html>
<head>
  <title>Code Block</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/default.min.css">
  <script>
    hljs.highlightAll();
  </script>
</head>
<body>
<h1>Code Block</h1>
<h3 id="codeBlockTitle"></h3>
<pre><code id="codeBlockCode" class="javascript"></code></pre>
<textarea id="codeBlockEditor" style="width:100%; height:200px;"></textarea>
<button id="updateButton">Update Code</button>

<script type="text/javascript">
  var socket = new SockJS('/ws');
  var stompClient = Stomp.over(socket);

  function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }

  var codeBlockId = getParameterByName('id');

  function connect() {
    stompClient.connect({}, function (frame) {
      console.log('Connected: ' + frame);
      stompClient.subscribe('/topic/codeblocks', function (message) {
        showCodeBlock(JSON.parse(message.body));
      });
    });
  }

  function showCodeBlock(codeBlock) {
    if (codeBlock.id == codeBlockId) {
      $("#codeBlockTitle").text(codeBlock.title);
      $("#codeBlockCode").text(codeBlock.code);
      hljs.highlightBlock(document.getElementById('codeBlockCode'));
      $("#codeBlockEditor").val(codeBlock.code);
    }
  }

  $(document).ready(function() {
    $.get("/api/codeblocks/" + codeBlockId, function(data) {
      showCodeBlock(data);
    });

    $("#updateButton").click(function() {
      var codeBlock = {
        id: codeBlockId,
        title: $("#codeBlockTitle").text(),
        code: $("#codeBlockEditor").val()
      };
      stompClient.send("/app/updateCodeBlock", {}, JSON.stringify(codeBlock));
    });

    connect();
  });
</script>
</body>
</html>
